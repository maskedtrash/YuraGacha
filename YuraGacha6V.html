<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YuraGacha</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 20px;
    background: #020617;
    color: #e5e7eb;
    font-family: system-ui, sans-serif;
  }

  .shell { width:100%; max-width:480px; }

  .card {
    padding: 18px;
    border-radius: 20px;
    background: rgba(15,23,42,0.85);
    border: 1px solid rgba(148,163,184,0.28);
    margin-top: 20px;
  }

  input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    margin-top: 8px;
    background: rgba(30,41,59,0.8);
    color: #e5e7eb;
  }

  .btn {
    width: 100%;
    padding: 12px;
    border-radius: 999px;
    border: none;
    margin-top: 12px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
  }

  .btn-success { background: #22c55e; color: #022c22; }
  .btn-dark { background: #111827; color:#e5e7eb; border:1px solid #374151; }
  .btn-red { background:#dc2626; color:white; }

  .link {
    color:#38bdf8;
    margin-top:8px;
    text-align:center;
    font-size:13px;
    cursor:pointer;
  }

  .file-zone { border:1px dashed #334155; padding:10px; border-radius:12px; }
  .number-box { margin-top:12px; padding:14px; background:#111827; border:1px solid #374151; border-radius:12px; }
  .number { font-size:24px; text-align:center; color:#22c55e; }

  #savedList span {
    background:#0f172a; border:1px solid #4b5563;
    padding:4px 8px; margin:2px; border-radius:6px; display:inline-block;
  }

  .admin-item {
    padding:10px;
    border-radius:10px;
    background:#0f172a;
    margin-top:8px;
    border:1px solid #334155;
  }
</style>
</head>
<body>
<div class="shell">

<!-- ================= LOG IN ================= -->
<div id="loginPage">
  <div class="card">
    <h2>Login</h2>

    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">

    <button class="btn btn-success" id="loginBtn">Login</button>

    <div class="link" onclick="showRegister()">Create account</div>

    <div id="loginMsg" style="margin-top:8px; color:#f87171;"></div>
  </div>
</div>

<!-- ================= REGISTER ================= -->
<div id="registerPage" style="display:none;">
  <div class="card">
    <h2>Register</h2>

    <input id="regUser" placeholder="Choose Username">
    <input id="regPass" type="password" placeholder="Choose Password">

    <button class="btn btn-success" id="regBtn">Register</button>

    <div class="link" onclick="showLogin()">Back to Login</div>
    <div id="regMsg" style="margin-top:8px; color:#f87171;"></div>
  </div>
</div>

<!-- ================= MAIN USER PAGE ================= -->
<div id="mainPage" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>YuraGacha</h2>
    <button class="btn-dark" onclick="logout()" style="padding:6px 12px;">Logout</button>
  </div>

  <!-- Upload -->
  <div class="card">
    <div class="file-zone">
      <input type="file" id="fileInput" accept=".txt">
    </div>
    <div id="statusText" style="margin-top:10px;">No file yet.</div>

    <div class="number-box">
      <div class="number" id="numberDisplay">—</div>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn-dark" id="copyBtn" disabled>Copy</button>
        <button class="btn-dark" id="saveBtn" disabled>Save</button>
      </div>

      <div id="emptyText" style="display:none; margin-top:6px; color:#94a3b8;">
        All numbers used.
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn-success" id="gachaBtn" disabled>GACHA</button>
      <button class="btn-dark" id="resetBtn">Clear</button>
    </div>

    <div id="counterText" style="margin-top:10px;"></div>
  </div>

  <!-- Saved -->
  <div class="card">
    <h3>Saved Numbers</h3>
    <div id="savedList">(empty)</div>
    <button class="btn-dark" id="clearSaved" style="margin-top:10px;width:100%;">Clear Saved</button>
  </div>
</div>

<!-- ================= ADMIN PANEL ================= -->
<div id="adminPage" style="display:none;">
  <h2>Admin Panel</h2>
  <button class="btn-dark" onclick="logout()" style="padding:6px 12px;">Logout</button>

  <div class="card">
    <h3>All Users</h3>
    <div id="adminUserList"></div>
  </div>
</div>

</div>

<script>
/* ======================= DATABASE ======================= */
function loadUsers(){ return JSON.parse(localStorage.getItem("yg_users") || "{}"); }
function saveUsers(o){ localStorage.setItem("yg_users", JSON.stringify(o)); }

function loadUserDB(){ return JSON.parse(localStorage.getItem("yg_userData") || "{}"); }
function saveUserDB(o){ localStorage.setItem("yg_userData", JSON.stringify(o)); }

/* ======================= PAGE SWITCH ======================= */
function showLogin(){ loginPage.style.display="block"; registerPage.style.display="none"; mainPage.style.display="none"; adminPage.style.display="none";}
function showRegister(){ loginPage.style.display="none"; registerPage.style.display="block"; mainPage.style.display="none"; adminPage.style.display="none";}
function showMain(){ loginPage.style.display="none"; registerPage.style.display="none"; mainPage.style.display="block"; adminPage.style.display="none";}
function showAdmin(){ loginPage.style.display="none"; registerPage.style.display="none"; mainPage.style.display="none"; adminPage.style.display="block"; }

/* ======================= AUTO LOGIN ======================= */
let active = localStorage.getItem("activeUser");
if(active){
  if(active === "admin") showAdmin();
  else showMain();
}

/* ======================= REGISTER ======================= */
regBtn.onclick = ()=>{
  let u = regUser.value.trim();
  let p = regPass.value.trim();
  let users = loadUsers();
  let db = loadUserDB();

  if(!u || !p){ regMsg.textContent="Both fields required."; return; }
  if(users[u]){ regMsg.textContent="Username exists."; return; }

  users[u] = p;
  db[u] = { saved: [] };

  saveUsers(users);
  saveUserDB(db);

  localStorage.setItem("activeUser", u);
  showMain();
};

/* ======================= LOGIN ======================= */
loginBtn.onclick = ()=>{
  let u = loginUser.value.trim();
  let p = loginPass.value.trim();
  let users = loadUsers();

  if(u==="admin" && p==="admin"){
    localStorage.setItem("activeUser","admin");
    refreshAdmin();
    showAdmin();
    return;
  }

  if(users[u] && users[u] === p){
    localStorage.setItem("activeUser", u);
    showMain();
  } else {
    loginMsg.textContent="Wrong username/password.";
  }
};

/* ======================= LOGOUT ======================= */
function logout(){
  localStorage.removeItem("activeUser");
  showLogin();
}

/* ======================= ADMIN PANEL ======================= */
function refreshAdmin(){
  let users = loadUsers();
  let db = loadUserDB();
  let box = document.getElementById("adminUserList");

  let html = "";

  for(let u in users){
    let saved = db[u]?.saved || [];

    html += `
      <div class="admin-item">
        <b>User:</b> ${u}<br>
        <b>Password:</b> ${users[u]}<br>
        <b>Saved (${saved.length}):</b><br>
        ${saved.length ? saved.map(x=>`<span>${x}</span>`).join("") : "(none)"}
        <br><br>
        <button class="btn-red" onclick="adminDeleteSaved('${u}')">Delete Saved</button>
        <button class="btn-red" onclick="adminDeleteUser('${u}')">Delete User</button>
      </div>
    `;
  }

  box.innerHTML = html || "(no users)";
}

function adminDeleteSaved(u){
  let db = loadUserDB();
  if(db[u]) db[u].saved = [];
  saveUserDB(db);
  refreshAdmin();
}

function adminDeleteUser(u){
  let users = loadUsers();
  let db = loadUserDB();

  delete users[u];
  delete db[u];

  saveUsers(users);
  saveUserDB(db);

  refreshAdmin();
}

/* ======================= GACHA SYSTEM ======================= */

let numbers = [];
let usedCount = 0;

const fileInput = document.getElementById("fileInput");
const numberDisplay = document.getElementById("numberDisplay");
const gachaBtn = document.getElementById("gachaBtn");
const resetBtn = document.getElementById("resetBtn");
const statusText = document.getElementById("statusText");
const emptyText = document.getElementById("emptyText");
const counterText = document.getElementById("counterText");
const copyBtn = document.getElementById("copyBtn");
const saveBtn = document.getElementById("saveBtn");
const savedList = document.getElementById("savedList");

function formatPlus(n){ return n.startsWith("+") ? n : "+"+n; }

/* Load saved for active user */
function loadSaved(){
  let u = localStorage.getItem("activeUser");
  let db = loadUserDB();

  if(!db[u]) db[u]={saved:[]};

  savedList.innerHTML = db[u].saved.length ?
    db[u].saved.map(x=>`<span>${x}</span>`).join("") :
    "(empty)";
}

/* Save number to user DB */
function saveNumber(n){
  let u = localStorage.getItem("activeUser");
  let db = loadUserDB();

  if(!db[u]) db[u]={saved:[]};

  if(!db[u].saved.includes(n)){
    db[u].saved.push(n);
    saveUserDB(db);
    loadSaved();
  }
}

fileInput.onchange = ()=>{
  const f = fileInput.files[0];
  if(!f) return;

  let r = new FileReader();
  r.onload = e=>{
    numbers = e.target.result.split(/\r?\n/).map(x=>x.trim()).filter(x=>x).map(formatPlus);
    usedCount=0;
    numberDisplay.textContent="—";
    gachaBtn.disabled = numbers.length==0;
    emptyText.style.display="none";
    statusText.textContent=`Loaded ${numbers.length} numbers`;
    update();
  };
  r.readAsText(f);
};

function update(){
  counterText.textContent = numbers.length ?
    `Remaining: ${numbers.length} • Used: ${usedCount}` : "";

  copyBtn.disabled = numberDisplay.textContent==="—";
  saveBtn.disabled = numberDisplay.textContent==="—";
}

gachaBtn.onclick = ()=>{
  if(numbers.length==0){
    emptyText.style.display="block";
    gachaBtn.disabled=true;
    return;
  }

  const i = Math.floor(Math.random()*numbers.length);
  const pick = numbers.splice(i,1)[0];
  usedCount++;
  numberDisplay.textContent = pick;
  update();
};

resetBtn.onclick = ()=>{
  numbers=[]; usedCount=0;
  fileInput.value="";
  numberDisplay.textContent="—";
  gachaBtn.disabled=true;
  emptyText.style.display="none";
  statusText.textContent="Session cleared.";
  update();
};

copyBtn.onclick = ()=>{
  navigator.clipboard.writeText(numberDisplay.textContent);
  statusText.textContent="Copied!";
};

saveBtn.onclick = ()=>{
  saveNumber(numberDisplay.textContent);
  statusText.textContent="Saved!";
};

clearSaved.onclick = ()=>{
  let u = localStorage.getItem("activeUser");
  let db = loadUserDB();

  db[u].saved = [];
  saveUserDB(db);
  loadSaved();
  statusText.textContent="Saved list cleared.";
};

loadSaved();
update();
</script>

</body>
</html>
